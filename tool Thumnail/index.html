<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YBNThumb AI - Ultimate Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f0f0f', 
                        darkcard: '#1e1e1e', 
                        accent: '#ff0000',
                        highlight: '#3b82f6'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f0f0f; color: #e5e5e5; font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e1e1e; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        
        /* Layout Grid Selection Effect */
        .layout-btn.selected { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        
        /* Spinner */
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #FF3D00;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen custom-scrollbar pb-20">

    <div id="apiKeyModal" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center hidden">
        <div class="bg-darkcard p-8 rounded-2xl border border-gray-800 w-full max-w-md shadow-2xl transform transition-all scale-100">
            <h2 class="text-2xl font-bold text-white mb-2 text-center">üîê X√°c th·ª±c</h2>
            <p class="text-gray-400 text-sm mb-6 text-center">Nh·∫≠p API Key Gemini c·ªßa b·∫°n ƒë·ªÉ m·ªü kh√≥a c√¥ng c·ª•.</p>
            
            <div class="relative mb-4">
                <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full bg-black border border-gray-700 rounded-xl p-4 text-white focus:border-blue-500 outline-none transition-colors">
            </div>
            
            <button onclick="saveApiKey()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3 rounded-xl transition shadow-lg">
                K·∫øt n·ªëi ngay
            </button>
            <div class="mt-4 text-center">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-gray-500 hover:text-white underline">Ch∆∞a c√≥ Key? L·∫•y t·∫°i ƒë√¢y</a>
            </div>
        </div>
    </div>

    <header class="border-b border-gray-800 bg-darkcard/80 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-red-600 to-red-900 rounded-lg flex items-center justify-center shadow-lg text-white font-bold text-xl">‚ñ∂</div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight">YBNThumb <span class="text-blue-500">Ultimate</span></h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">High CTR Generator</p>
                </div>
            </div>

            <div class="flex items-center gap-2 bg-black/30 p-1 rounded-lg border border-gray-800">
                <span class="text-[10px] text-gray-500 pl-2">AI Model:</span>
                <select id="modelSelect" class="bg-transparent text-xs text-white outline-none border-none p-1 cursor-pointer font-mono">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Nhanh)</option>
                    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (Th√¥ng minh)</option>
                    <option value="gemini-pro">Gemini 1.0 Pro (·ªîn ƒë·ªãnh nh·∫•t)</option>
                </select>
            </div>
            
            <button onclick="clearKey()" class="text-xs text-gray-500 hover:text-red-400 ml-4">ƒê·ªïi Key</button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">

        <div id="errorBox" class="hidden mb-6 p-4 bg-red-900/20 border border-red-500/50 rounded-xl flex items-start gap-3 animate-pulse-slow">
            <span class="text-2xl">‚ö†Ô∏è</span>
            <div>
                <h3 class="font-bold text-red-400 text-sm">L·ªói k·∫øt n·ªëi AI</h3>
                <p id="errorText" class="text-xs text-red-200 mt-1 font-mono"></p>
                <p class="text-xs text-gray-400 mt-2">üëâ H√£y th·ª≠ ch·ªçn <b>Model kh√°c</b> ·ªü menu tr√™n c√πng v√† b·∫•m l·∫°i n√∫t Ph√¢n t√≠ch.</p>
            </div>
        </div>

        <section id="step1" class="animate-fade-in">
            <div class="bg-darkcard border border-gray-800 rounded-2xl p-1 shadow-2xl">
                <div class="bg-gradient-to-b from-[#1a1a1a] to-[#0f0f0f] rounded-xl p-8">
                    <label class="block text-sm font-semibold text-blue-400 mb-3 tracking-wide">N·ªòI DUNG VIDEO / √ù T∆Ø·ªûNG K·ªäCH B·∫¢N</label>
                    <textarea id="videoInput" rows="5" class="w-full bg-[#050505] border border-gray-800 rounded-xl p-5 text-gray-100 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition resize-none text-lg placeholder-gray-700 leading-relaxed" placeholder="V√≠ d·ª•: B√≠ ·∫©n Tam gi√°c Bermuda, phong c√°ch phim t√†i li·ªáu, kinh d·ªã, u √°m..."></textarea>
                    
                    <div class="flex flex-col md:flex-row justify-between items-center mt-6 gap-4">
                        <label class="flex items-center gap-3 px-4 py-2 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-800 border border-gray-800 transition group w-full md:w-auto">
                            <svg class="w-5 h-5 text-gray-500 group-hover:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span id="imageLabel" class="text-sm text-gray-400 group-hover:text-white">T·∫£i ·∫£nh n·ªÅn (T√πy ch·ªçn)</span>
                            <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="handleImage(this)">
                        </label>

                        <button onclick="analyzeContent()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold px-10 py-3 rounded-xl shadow-lg shadow-blue-900/30 transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                            <span>Ph√¢n t√≠ch & G·ª£i √Ω VƒÉn b·∫£n</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div id="loadingUI" class="hidden flex flex-col items-center justify-center py-20">
            <div class="loader mb-6"></div>
            <p class="text-gray-400 font-medium animate-pulse tracking-widest uppercase text-sm">ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...</p>
        </div>

        <section id="step2" class="hidden space-y-8">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-darkcard border border-gray-800 p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition text-6xl">üéØ</div>
                    <h3 class="text-blue-500 font-bold text-xs uppercase mb-3 tracking-widest">Chi·∫øn l∆∞·ª£c h√¨nh ·∫£nh</h3>
                    <p id="strategyText" class="text-gray-300 text-sm leading-relaxed"></p>
                </div>
                <div class="bg-darkcard border border-gray-800 p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition text-6xl">üß†</div>
                    <h3 class="text-purple-500 font-bold text-xs uppercase mb-3 tracking-widest">ƒê√°nh v√†o t√¢m l√Ω</h3>
                    <p id="reasoningText" class="text-gray-400 text-sm italic leading-relaxed"></p>
                </div>
            </div>

            <div class="bg-darkcard border border-gray-800 p-6 rounded-2xl">
                <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                    <span class="text-yellow-500">‚úçÔ∏è</span> Ch·ªçn Text tr√™n ·∫£nh (Hooks)
                </h3>
                <div id="hooksContainer" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                <input type="text" id="customHook" placeholder="Ho·∫∑c nh·∫≠p text t√πy ch·ªânh c·ªßa b·∫°n..." class="mt-4 w-full bg-[#0a0a0a] border border-gray-800 rounded-lg p-3 text-sm text-white focus:border-blue-500 transition">
            </div>

            <div class="bg-darkcard border border-gray-800 p-6 rounded-2xl">
                <h3 class="text-white font-bold mb-4 text-sm uppercase text-gray-400">Ch·ªçn B·ªë c·ª•c (Layout)</h3>
                <div class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar">
                    <button onclick="selectLayout('Classic', this)" class="layout-btn selected min-w-[100px] p-2 border border-gray-700 rounded-lg hover:border-blue-500 bg-black flex flex-col items-center gap-2 transition">
                        <div class="w-full h-12 bg-gray-800 rounded relative"><div class="absolute right-1 top-2 w-1/2 h-2 bg-yellow-500"></div><div class="absolute left-2 bottom-0 w-8 h-8 bg-gray-600 rounded-t-full"></div></div>
                        <span class="text-[10px] text-gray-400">C·ªï ƒëi·ªÉn</span>
                    </button>
                    <button onclick="selectLayout('Face Close-up', this)" class="layout-btn min-w-[100px] p-2 border border-gray-700 rounded-lg hover:border-blue-500 bg-black flex flex-col items-center gap-2 transition">
                        <div class="w-full h-12 bg-gray-800 rounded relative flex justify-center items-end"><div class="w-10 h-10 bg-gray-600 rounded-t-full"></div></div>
                        <span class="text-[10px] text-gray-400">C·∫≠n m·∫∑t</span>
                    </button>
                    <button onclick="selectLayout('Split Screen', this)" class="layout-btn min-w-[100px] p-2 border border-gray-700 rounded-lg hover:border-blue-500 bg-black flex flex-col items-center gap-2 transition">
                        <div class="w-full h-12 bg-gray-800 rounded relative flex"><div class="w-1/2 border-r border-black"></div></div>
                        <span class="text-[10px] text-gray-400">Chia ƒë√¥i</span>
                    </button>
                    <button onclick="selectLayout('Object Focus', this)" class="layout-btn min-w-[100px] p-2 border border-gray-700 rounded-lg hover:border-blue-500 bg-black flex flex-col items-center gap-2 transition">
                        <div class="w-full h-12 bg-gray-800 rounded relative flex items-center justify-center"><div class="w-6 h-6 bg-red-500 rounded"></div></div>
                        <span class="text-[10px] text-gray-400">S·∫£n ph·∫©m</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-darkcard border border-gray-800 rounded-xl p-3">
                    <label class="text-[10px] text-gray-500 block mb-1">Ch·ªß th·ªÉ</label>
                    <select id="subjectSelect" class="w-full bg-transparent text-white text-sm outline-none border-none"><option>T·ª± (Self)</option><option>Nam</option><option>N·ªØ</option><option>S·∫£n ph·∫©m</option><option>Kh√¥ng ng∆∞·ªùi</option></select>
                </div>
                <div class="bg-darkcard border border-gray-800 rounded-xl p-3">
                    <label class="text-[10px] text-gray-500 block mb-1">C·∫£m x√∫c</label>
                    <select id="emotionSelect" class="w-full bg-transparent text-white text-sm outline-none border-none"><option>S·ªëc / Ng·∫°c nhi√™n</option><option>T·ª©c gi·∫≠n</option><option>Vui v·∫ª</option><option>S·ª£ h√£i</option><option>Nghi√™m t√∫c</option></select>
                </div>
                <div class="bg-darkcard border border-gray-800 rounded-xl p-3">
                    <label class="text-[10px] text-gray-500 block mb-1">Style Text</label>
                    <select id="textStyleSelect" class="w-full bg-transparent text-white text-sm outline-none border-none"><option>3D Kh·ªëi N·ªïi</option><option>Neon</option><option>ƒê∆°n gi·∫£n</option><option>Kinh d·ªã</option></select>
                </div>
                <div class="bg-darkcard border border-gray-800 rounded-xl p-3">
                    <label class="text-[10px] text-gray-500 block mb-1">ƒê·ªì h·ªça</label>
                    <select id="artStyleSelect" class="w-full bg-transparent text-white text-sm outline-none border-none"><option>Si√™u th·ª±c (8k)</option><option>3D Pixar</option><option>Anime</option><option>Cinematic</option></select>
                </div>
            </div>

            <input type="text" id="extraNote" placeholder="Ghi ch√∫ th√™m (VD: N·ªÅn m√†u xanh, tr·ªùi m∆∞a...)" class="w-full bg-darkcard border border-gray-800 rounded-xl p-4 text-sm text-gray-300 focus:border-blue-500 transition">

            <div class="flex justify-end gap-4 pt-6 border-t border-gray-800">
                <button onclick="resetApp()" class="px-6 py-3 text-sm text-gray-500 hover:text-white">L√†m l·∫°i</button>
                <button onclick="generateFinalPrompt()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-8 py-3 rounded-xl shadow-lg transition flex items-center gap-2">
                    ‚ú® T·∫°o Prompt Chi Ti·∫øt
                </button>
            </div>
        </section>

        <section id="step3" class="hidden space-y-6">
            <div class="bg-darkcard border border-gray-700 rounded-2xl overflow-hidden shadow-2xl">
                <div class="bg-gray-800/50 p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="font-bold text-blue-400 text-sm uppercase">Prompt Midjourney / DALL-E</h3>
                    <button onclick="copyText('finalPrompt')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded transition">Sao ch√©p</button>
                </div>
                <div class="p-6 bg-[#050505] relative group">
                    <p id="finalPrompt" class="text-gray-300 font-mono text-sm leading-7 select-all"></p>
                </div>
            </div>

            <div class="bg-darkcard border border-gray-800 rounded-2xl p-6">
                <h3 class="font-bold text-gray-500 text-xs uppercase mb-3">M√¥ t·∫£ chi ti·∫øt (Ti·∫øng Vi·ªát)</h3>
                <p id="vnDescription" class="text-gray-300 text-sm leading-relaxed"></p>
            </div>

            <button onclick="document.getElementById('step3').classList.add('hidden'); document.getElementById('step2').classList.remove('hidden');" class="w-full text-center text-gray-500 text-sm hover:text-white py-4">‚¨Ö Quay l·∫°i ch·ªânh s·ª≠a</button>
        </section>

    </main>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Global State
        let selectedLayoutName = "Classic";
        let analysisData = null;

        // --- UTILS ---
        window.saveApiKey = () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key.startsWith('AIza')) { localStorage.setItem('gemini_api_key', key); document.getElementById('apiKeyModal').classList.add('hidden'); }
            else { alert("Key kh√¥ng h·ª£p l·ªá (Ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng AIza)"); }
        }
        window.clearKey = () => { if(confirm("X√≥a Key?")) { localStorage.removeItem('gemini_api_key'); location.reload(); } }
        window.handleImage = (input) => { if(input.files[0]) { document.getElementById('imageLabel').innerText = "‚úÖ " + input.files[0].name; document.getElementById('imageLabel').classList.add('text-green-400'); } }
        window.selectLayout = (name, btn) => {
            selectedLayoutName = name;
            document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        window.copyText = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("ƒê√£ sao ch√©p!"); }
        window.resetApp = () => { document.getElementById('step2').classList.add('hidden'); document.getElementById('step3').classList.add('hidden'); document.getElementById('step1').classList.remove('hidden'); window.scrollTo(0,0); }
        window.selectHook = (text) => { document.getElementById('customHook').value = text; }

        // --- CORE LOGIC ---
        // H√†m g·ªçi AI chung ƒë·ªÉ x·ª≠ l√Ω l·ªói 404
        async function callGemini(promptText) {
            const apiKey = localStorage.getItem('gemini_api_key');
            if(!apiKey) { document.getElementById('apiKeyModal').classList.remove('hidden'); throw new Error("No Key"); }

            // L·∫•y model t·ª´ menu ch·ªçn
            const modelName = document.getElementById('modelSelect').value;
            console.log("Calling Model:", modelName);

            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: modelName });

            try {
                const result = await model.generateContent(promptText);
                const text = result.response.text();
                // L·ªçc JSON
                let cleanJson = text.replace(/```json|```/g, '').trim();
                const start = cleanJson.indexOf('{');
                const end = cleanJson.lastIndexOf('}');
                if(start !== -1 && end !== -1) cleanJson = cleanJson.substring(start, end+1);
                return JSON.parse(cleanJson);
            } catch (error) {
                console.error("AI Error:", error);
                throw error; // N√©m l·ªói ra ngo√†i ƒë·ªÉ h√†m main x·ª≠ l√Ω
            }
        }

        // --- PHASE 1: ANALYZE ---
        window.analyzeContent = async () => {
            const input = document.getElementById('videoInput').value;
            if(!input) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('loadingUI').classList.remove('hidden');
            document.getElementById('errorBox').classList.add('hidden');

            try {
                const prompt = `
                Role: YouTube Expert. Task: Analyze video idea: "${input}".
                Return JSON only:
                {
                    "strategy": "Vietnamese strategy (short)",
                    "reasoning": "Psychology (Vietnamese)",
                    "hooks": ["Hook 1", "Hook 2", "Hook 3"]
                }`;
                
                const data = await callGemini(prompt);
                
                // Render Step 2
                document.getElementById('loadingUI').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                
                document.getElementById('strategyText').innerText = data.strategy;
                document.getElementById('reasoningText').innerText = data.reasoning;
                
                const container = document.getElementById('hooksContainer');
                container.innerHTML = '';
                data.hooks.forEach(h => {
                    const btn = document.createElement('div');
                    btn.className = "p-3 bg-gray-900 border border-gray-800 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-gray-800 transition text-sm text-center";
                    btn.innerText = `"${h}"`;
                    btn.onclick = () => window.selectHook(h);
                    container.appendChild(btn);
                });

            } catch (e) {
                document.getElementById('loadingUI').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('errorBox').classList.remove('hidden');
                
                let msg = e.message;
                if(msg.includes('404')) msg = `Model kh√¥ng t√¨m th·∫•y (404). H√£y ƒë·ªïi Model kh√°c ·ªü menu tr√™n c√πng.`;
                else if(msg.includes('400')) msg = `API Key kh√¥ng h·ª£p l·ªá.`;
                document.getElementById('errorText').innerText = msg;
            }
        }

        // --- PHASE 2: GENERATE PROMPT ---
        window.generateFinalPrompt = async () => {
            const input = document.getElementById('videoInput').value;
            const hook = document.getElementById('customHook').value || "TEXT HERE";
            const subject = document.getElementById('subjectSelect').value;
            const emotion = document.getElementById('emotionSelect').value;
            const style = document.getElementById('textStyleSelect').value;
            const art = document.getElementById('artStyleSelect').value;
            const note = document.getElementById('extraNote').value;

            document.getElementById('step2').classList.add('hidden');
            document.getElementById('loadingUI').classList.remove('hidden');

            try {
                const prompt = `
                Create Midjourney Prompt.
                Context: Video="${input}", Layout="${selectedLayoutName}".
                Elements: Subject=${subject}, Emotion=${emotion}, Text="${hook}" (Style: ${style}), Art=${art}, Note=${note}.
                
                Return JSON only:
                {
                    "midjourney_prompt": "English prompt v6 highly detailed...",
                    "vietnamese_desc": "Vietnamese visual description..."
                }`;

                const data = await callGemini(prompt);

                document.getElementById('loadingUI').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                
                document.getElementById('finalPrompt').innerText = data.midjourney_prompt + " --ar 16:9 --v 6.0 --style raw";
                document.getElementById('vnDescription').innerText = data.vietnamese_desc;

            } catch (e) {
                document.getElementById('loadingUI').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                alert("L·ªói t·∫°o prompt: " + e.message + "\n(H√£y th·ª≠ ƒë·ªïi Model)");
            }
        }

        if(!localStorage.getItem('gemini_api_key')) document.getElementById('apiKeyModal').classList.remove('hidden');
    </script>
</body>
</html>
